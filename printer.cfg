
## Include other config files

[include shell_command.cfg]
[include macros/*.cfg]
[include reshelper.cfg]
[include K-ShakeTune/*.cfg]
[include reshelper.cfg]

#####################################################################
#  Misc
#####################################################################

[printer]
kinematics: cartesian
max_velocity: 1200  
max_accel: 25000
max_accel_to_decel: 25000
max_z_velocity: 75          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 2000
square_corner_velocity: 15.0

[virtual_sdcard]
path: ~/printer_data/gcodes

[display_status]

[respond]

[pause_resume]

[save_variables]
filename: ~/printer_data/config/saved_variables.cfg

[exclude_object]

# Enable arcs support
[gcode_arcs]
resolution: 0.1

[firmware_retraction]
retract_length: 0.5
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 40
#   The speed of retraction, in mm/s. The default is 20 mm/s.
#unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 40
#   The speed of unretraction, in mm/s. The default is 10 mm/s.
#z_hop_height: 0.0
#   The vertical height by which the nozzle is lifted from the print to
#   prevent collisions with the print during travel moves when retracted.
#   The minimum value is 0 mm, the default value is 0 mm, which disables
#   zhop moves.

#####################################################################
#  Controllers
#####################################################################
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_1F0034001551303531313638-if00

restart_method: command

#[mcu rpi]
#serial: /tmp/klipper_host_mcu


#####################################################################
#   Probe
#####################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_0D5B9EEF4E5737374D202020FF0F1B13-if00
x_offset: -19.5 # update with offset from nozzle on your machine
y_offset: 0 # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
accel_axes_map: y, x, z


# Mesh Bed Settings
[bed_mesh]
speed: 425
horizontal_move_z: 1
mesh_min: 25,25
mesh_max: 150,150
probe_count: 25,25
fade_start: 1.0
fade_end: 10.0
move_check_distance: 3
split_delta_z: 0.01
mesh_pps: 0,0
algorithm: bicubic
bicubic_tension: 0.2

[safe_z_home]
home_xy_position: 107.5, 90 # update for your machine
z_hop: 3

#####################################################################
#   ADXL
#####################################################################

[resonance_tester]
accel_chip: beacon
probe_points: 90, 90, 20
accel_per_hz: 100
hz_per_sec: 0.5
max_freq: 110

[input_shaper]
shaper_freq_x: 100.2
shaper_type_x: mzv
damping_ratio_x: 0.043

shaper_freq_y: 90.2
shaper_type_y: mzv
damping_ratio_y: 0.036

#####################################################################
#   Fan Control
#####################################################################

[heater_fan hotend_fan]
pin: PA5
tachometer_pin: PC3
heater: extruder
heater_temp: 50.0
#kick_start_time: 0.5

[fan]
pin: PA6
off_below: 0.05
#max_power: 1.0
#cycle_time: 0.2
#kick_start_time: 0.5


[controller_fan casefan1]
pin: PA4
kick_start_time: 0.5

fan_speed: 0.5


[controller_fan casefan2]
pin: PA3
kick_start_time: 0.5
heater: heater_bed
fan_speed: 0.5

[fan_generic rebreather]
pin: PF8
tachometer_pin: PC1

#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
##  SSR Pin - HE1
##  Thermistor - THB
heater_pin: PA0
sensor_type: Generic 3950
sensor_pin: PB1
pullup_resistor: 4700
max_power: 0.6
min_temp: 0
max_temp: 120
smooth_time: 2.0
#control = pid
#pid_kp = 52.779
#pid_ki = 1.419
#pid_kd = 490.844

#####################################################################
#   Extruder
#####################################################################

##  Connected to Motor 8
##  Heater - HE0
##  Thermistor - T0
##LDO-36STH17-0354AH(G8T)
[extruder]
step_pin: PA10
dir_pin: PA9
enable_pin: !PA15
rotation_distance: 22.196 #for 5mm Shaft Driven Bondtech gearsets
#gear_ratio: 50:10 #for standard 10t motor
gear_ratio: 50:8 #for sherpa mini 8t motor
microsteps: 16
full_steps_per_rotation: 200 #1.8deg Motor
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PF6
sensor_type: PT1000
sensor_pin: PB0
pullup_resistor: 2200
min_temp: 0
max_temp: 320
max_power: 1.0
min_extrude_temp: 0
max_extrude_only_distance: 200
max_extrude_cross_section: 5
pressure_advance: 0.03
pressure_advance_smooth_time: 0.02
#control = pid
#pid_kp = 24.103
#pid_ki = 2.329
#pid_kd = 62.368

#####################################################################
#   X/Y/Z Stepper Settings
#####################################################################

[stepper_x]
# connected to Motor 1
step_pin: PC13
dir_pin: !PC14
enable_pin: !PE6
# 0.9deg - 160 steps per mm - 1/16 microstepping
rotation_distance: 40
microsteps: 256
full_steps_per_rotation: 400
endstop_pin: tmc5160_stepper_x:virtual_endstop
#endstop_pin: PB14  # min
#endstop_pin: PA1   # max
position_min: -9
position_endstop: 180
position_max: 180
homing_speed: 100
homing_retract_dist: 20
use_sensorless_homing: true

[stepper_x1]
# connected to Motor 2
step_pin: PE4
dir_pin: PE5
enable_pin: !PE3
# 0.9deg - 160 steps per mm - 1/16 microstepping
rotation_distance: 40
microsteps: 256
full_steps_per_rotation: 400


[stepper_y]
# connected to Motor 3
step_pin: PE1
dir_pin: !PE0
enable_pin: !PE2
# 0.9deg - 160 steps per mm - 1/16 microstepping
rotation_distance: 40
microsteps: 256
full_steps_per_rotation: 400
endstop_pin: tmc5160_stepper_y:virtual_endstop
#endstop_pin: PB13  # min
#endstop_pin: PA2   # max
position_min: 0
position_endstop: 0
position_max: 184.5
homing_speed: 100
homing_retract_dist: 20
use_sensorless_homing: true

[stepper_y1]
# connected to Motor 4
step_pin: PB8
dir_pin: PB9
enable_pin: !PB7
# 0.9deg - 160 steps per mm - 1/16 microstepping
rotation_distance: 40
microsteps: 256
full_steps_per_rotation: 400



[stepper_z]
# connected to Motor 5
step_pin: PB5
dir_pin: PB4
enable_pin: !PB6
# 0.9deg - 2mm pitch 2mm lead - 1/8 microstepping
full_steps_per_rotation: 200
rotation_distance: 40
microsteps: 64
gear_ratio: 80:20
#position_endstop: 0
#endstop_pin:PB15
endstop_pin: probe:z_virtual_endstop
position_max: 170
position_min: -1
homing_speed: 25
homing_retract_dist: 0

[stepper_z1]
# connected to MOTOR 6
step_pin: PG15
dir_pin: !PB3
enable_pin: !PD5
# 0.9deg - 2mm pitch 2mm lead - 1/8 microstepping
full_steps_per_rotation: 200
microsteps: 64
rotation_distance: 40
gear_ratio: 80:20

[stepper_z2]
# connected to Motor 7
step_pin: PD3
dir_pin: !PD2
enable_pin: !PD4
# 0.9deg - 2mm pitch 2mm lead - 1/8 microstepping
full_steps_per_rotation: 200
microsteps: 64
rotation_distance: 40
gear_ratio: 80:20


# TMC Stepper Driver Settings
[tmc5160 stepper_x]
#uart_pin: PE8
#tx_pin: PE9    # comment out if using BTT 2209 drivers, and add a jumper between pins 4 and 5 of the driver
spi_bus: spi4
cs_pin: PG14
sense_resistor: 0.075
# Place a jumper on the two pin header near the endstop for sensorless homing
diag1_pin: ^!PF0  # connected to X- Endstop (X Jumper Header)
interpolate: false
home_current: 0.5
run_current: 1.768
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3
driver_SGT: 1

[tmc5160 stepper_x1]
spi_bus: spi4
cs_pin: PG13
#uart_pin: PE0
#tx_pin: PE1    # comment out if using BTT 2209 drivers, and add a jumper between pins 4 and 5 of the driver
sense_resistor: 0.075
# Place a jumper on the two pin header near the endstop for sensorless homing
diag1_pin: ^!PF2   # connected to X+ Endstop (E2 Jumper Header)
interpolate: false
home_current: 0.5
run_current: 1.768
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3

[tmc5160 stepper_y]
#uart_pin: PC4
#tx_pin: PE14   # comment out if using BTT 2209 drivers, and add a jumper between pins 4 and 5 of the driver
spi_bus: spi4
cs_pin: PG12
sense_resistor: 0.075
# Place a jumper on the two pin header near the endstop for sensorless homing
diag1_pin: ^!PF4
interpolate: false
home_current: 0.5
run_current: 1.768
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3
driver_SGT: 1

[tmc5160 stepper_y1]
#uart_pin: PD12
#tx_pin: PC4    # comment out if using BTT 2209 drivers, and add a jumper between pins 4 and 5 of the driver
spi_bus: spi4
cs_pin: PG11
sense_resistor: 0.075
# Place a jumper on the two pin header near the endstop for sensorless homing
diag1_pin: ^!PF3
interpolate: false
home_current: 0.7
run_current: 1.768
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3

[tmc2209 stepper_z]
uart_pin: PG10
interpolate: False
sense_resistor: 0.110
run_current: 1.1
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3

[tmc2209 stepper_z1]
uart_pin: PG9
interpolate: False
sense_resistor: 0.110
run_current: 1.1
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3

[tmc2209 stepper_z2]
uart_pin: PD7
interpolate: False
sense_resistor: 0.110
run_current: 1.1
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3

[tmc2209 extruder]
uart_pin: PD6
interpolate: false
run_current: 0.4
sense_resistor: 0.110

#####################################################################
# 	Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

# Z Tilt Bed Adjustment Settings
[z_tilt]
# these positions assume the bed and rear rail are shifted 12mm to the right from what is in the edrawing
z_positions: 
    226.0, -18.0    # Front Right
    -74.0, -18.0    # Front Left
    76.0,  217.0    # Rear
points:
    170, 35         # Front Right
    40, 35          # Front Left
    110, 165        # Rear

Speed: 500
horizontal_move_z: 5.0
retries: 8
retry_tolerance: 0.005

#####################################################################
#   Additional Sensors
#####################################################################

[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PC5
min_temp: 0
max_temp: 100
gcode_id: chamber_th

[temperature_sensor Octopus]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 0
max_temp: 110

#####################################################################
#   Gyroid Tweaks
#####################################################################

[gcode_macro _USE_INFILL_SQV]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set sqv = svv.infill_sqv | default(printer.configfile.settings.printer.square_corner_velocity, true) %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={ sqv }

[gcode_macro _USE_NORMAL_SQV]
gcode:
    {% set sqv = printer.configfile.settings.printer.square_corner_velocity %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={ sqv }

[gcode_macro SET_INFILL_SQV]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set val = params.SQV|default(svv.infill_sqv|default(printer.configfile.settings.printer.square_corner_velocity, true), true) | int %}
    SAVE_VARIABLE VARIABLE=infill_sqv VALUE={val}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.081324, -0.078978, -0.062366, -0.047922, -0.062402, -0.080721, -0.085546, -0.087447, -0.087167, -0.089679, -0.091281, -0.093475, -0.094787, -0.095990, -0.098485, -0.102852, -0.102692, -0.100451, -0.096901, -0.091868, -0.088121, -0.085205, -0.085168, -0.087037, -0.088255
#*# 	  -0.075229, -0.069938, -0.059072, -0.048092, -0.062917, -0.074113, -0.076816, -0.074979, -0.075379, -0.079584, -0.083657, -0.082023, -0.084889, -0.086022, -0.086329, -0.090467, -0.091355, -0.089560, -0.084696, -0.081154, -0.079466, -0.075137, -0.074188, -0.076505, -0.076353
#*# 	  -0.053808, -0.048926, -0.048203, -0.044256, -0.039597, -0.037613, -0.039039, -0.038447, -0.040316, -0.045020, -0.044147, -0.042522, -0.044381, -0.046069, -0.046828, -0.050776, -0.054215, -0.052652, -0.050381, -0.049029, -0.049166, -0.047522, -0.049929, -0.053769, -0.061353
#*# 	  -0.039028, -0.035393, -0.025862, -0.015071, -0.005822, -0.007107, -0.012819, -0.014056, -0.016833, -0.015394, -0.014043, -0.013272, -0.014667, -0.016296, -0.015479, -0.018733, -0.021786, -0.021066, -0.019140, -0.017419, -0.020129, -0.023269, -0.024219, -0.023739, -0.031420
#*# 	  -0.042290, -0.031018, -0.017566, -0.008817, -0.004219, -0.007670, -0.015316, -0.017928, -0.019134, -0.016548, -0.016444, -0.018012, -0.018769, -0.019177, -0.019483, -0.022160, -0.025950, -0.027111, -0.026263, -0.022132, -0.024781, -0.030169, -0.023133, -0.011296, -0.011182
#*# 	  -0.045345, -0.030949, -0.027088, -0.027730, -0.024166, -0.025635, -0.033023, -0.033764, -0.036514, -0.035209, -0.034412, -0.033714, -0.031566, -0.030151, -0.028354, -0.028699, -0.029423, -0.026661, -0.020483, -0.016188, -0.011675, -0.011016, -0.005366, -0.002264, -0.000823
#*# 	  -0.024774, -0.024918, -0.027422, -0.027085, -0.025443, -0.026387, -0.027075, -0.028527, -0.031424, -0.032025, -0.029964, -0.027273, -0.024232, -0.022675, -0.021237, -0.020083, -0.020717, -0.017559, -0.014126, -0.009731, -0.004578, 0.002681, 0.009146, 0.011868, 0.004816
#*# 	  -0.020112, -0.021780, -0.022771, -0.022065, -0.023206, -0.022925, -0.023878, -0.024529, -0.027337, -0.026790, -0.025211, -0.023033, -0.021070, -0.018862, -0.016784, -0.017117, -0.018009, -0.016266, -0.012334, -0.009323, -0.004529, 0.001649, -0.001115, 0.008665, 0.019337
#*# 	  -0.029732, -0.029276, -0.029833, -0.026023, -0.023140, -0.022846, -0.021284, -0.023590, -0.025863, -0.026275, -0.025716, -0.024230, -0.019689, -0.018605, -0.019075, -0.018891, -0.019117, -0.016878, -0.015085, -0.012621, -0.005189, -0.000567, -0.004892, 0.009439, 0.008263
#*# 	  -0.041171, -0.035623, -0.032241, -0.024380, -0.020801, -0.018993, -0.018313, -0.016869, -0.017048, -0.016212, -0.013142, -0.010300, -0.007155, -0.008986, -0.019585, -0.023324, -0.021960, -0.019950, -0.016875, -0.013372, -0.008470, -0.001686, 0.011486, 0.014250, -0.003100
#*# 	  -0.051271, -0.043600, -0.037162, -0.025068, -0.018045, -0.014055, -0.011587, -0.009655, -0.009770, -0.010609, -0.014318, -0.016523, -0.013579, -0.005057, -0.008547, -0.018282, -0.021592, -0.018884, -0.015016, -0.008334, -0.008591, -0.000637, 0.017518, 0.007808, -0.000559
#*# 	  -0.065832, -0.051945, -0.034584, -0.021903, -0.014497, -0.009955, -0.008841, -0.008218, -0.014086, -0.018871, -0.023072, -0.023864, -0.020201, -0.009274, -0.003803, -0.008211, -0.017464, -0.013345, -0.008996, -0.003516, 0.001978, 0.011370, 0.013793, 0.012257, 0.010745
#*# 	  -0.066263, -0.049709, -0.033181, -0.034470, -0.033401, -0.025279, -0.020759, -0.019392, -0.024287, -0.025198, -0.026304, -0.025842, -0.020613, -0.012531, -0.004303, 0.001566, -0.001099, -0.002701, -0.001860, -0.001226, 0.002767, 0.018348, 0.016316, 0.014690, 0.014878
#*# 	  -0.060541, -0.050581, -0.049998, -0.057418, -0.047172, -0.032042, -0.024629, -0.021613, -0.020008, -0.016297, -0.016456, -0.017086, -0.019606, -0.024571, -0.017516, -0.007494, -0.005541, -0.007761, 0.002736, 0.009449, 0.016618, 0.019331, 0.009958, 0.014063, 0.019281
#*# 	  -0.061052, -0.065846, -0.063646, -0.050758, -0.031608, -0.025026, -0.022849, -0.024821, -0.019227, -0.013735, -0.008925, -0.010007, -0.015208, -0.021719, -0.017671, -0.006828, 0.001111, 0.003844, 0.003870, 0.004470, 0.017571, 0.020590, 0.015508, 0.019128, 0.022261
#*# 	  -0.088926, -0.089713, -0.058004, -0.036152, -0.026801, -0.024792, -0.024784, -0.023601, -0.021576, -0.017312, -0.014204, -0.016624, -0.020074, -0.020116, -0.015104, -0.011366, -0.004211, 0.007327, 0.014320, 0.022393, 0.024831, 0.021274, 0.017499, 0.021151, 0.026536
#*# 	  -0.090044, -0.073431, -0.051363, -0.037267, -0.030571, -0.028353, -0.029381, -0.027154, -0.025980, -0.024624, -0.029885, -0.030054, -0.027127, -0.027835, -0.019148, -0.011790, -0.002455, 0.007548, 0.013374, 0.027115, 0.027731, 0.025928, 0.022504, 0.026242, 0.026847
#*# 	  -0.080633, -0.074588, -0.056767, -0.046966, -0.043078, -0.039676, -0.037580, -0.036655, -0.037074, -0.042698, -0.047127, -0.039531, -0.034234, -0.035359, -0.024612, -0.014830, -0.002511, 0.011957, 0.023171, 0.030149, 0.031179, 0.028543, 0.022904, 0.025761, 0.027480
#*# 	  -0.092421, -0.092883, -0.065009, -0.056275, -0.063329, -0.055336, -0.052282, -0.056359, -0.064217, -0.064369, -0.048746, -0.043307, -0.041222, -0.038263, -0.027147, -0.010655, -0.008257, 0.002959, 0.018144, 0.026271, 0.026015, 0.026523, 0.023336, 0.025974, 0.024918
#*# 	  -0.119119, -0.104930, -0.081816, -0.062357, -0.059432, -0.057226, -0.053749, -0.055556, -0.059225, -0.052561, -0.046721, -0.048690, -0.047446, -0.040699, -0.027276, -0.018859, -0.009323, 0.003279, 0.007598, 0.018553, 0.022394, 0.022843, 0.019631, 0.024646, 0.026189
#*# 	  -0.123980, -0.114052, -0.098454, -0.085754, -0.073051, -0.064433, -0.060494, -0.058561, -0.057360, -0.059733, -0.058296, -0.051379, -0.042887, -0.036908, -0.027706, -0.029197, -0.021655, 0.000652, 0.001313, 0.007541, 0.013586, 0.014856, 0.016695, 0.024464, 0.023135
#*# 	  -0.129221, -0.118554, -0.108377, -0.100281, -0.095205, -0.089200, -0.081563, -0.076246, -0.074703, -0.077942, -0.077457, -0.064510, -0.056419, -0.051963, -0.038827, -0.026767, -0.021164, -0.018588, -0.012935, 0.002373, 0.007413, 0.010567, 0.012847, 0.020190, 0.027280
#*# 	  -0.119312, -0.113143, -0.100520, -0.093523, -0.096943, -0.096062, -0.084759, -0.078852, -0.070161, -0.074700, -0.083319, -0.064416, -0.051627, -0.048104, -0.048462, -0.043869, -0.030269, -0.021788, -0.018478, -0.010228, -0.002176, 0.008305, 0.011442, 0.018000, 0.026477
#*# 	  -0.128569, -0.119965, -0.103461, -0.093959, -0.089584, -0.082421, -0.081091, -0.081174, -0.081774, -0.077044, -0.067020, -0.061413, -0.061068, -0.052959, -0.047927, -0.042501, -0.040824, -0.031390, -0.025081, -0.010924, -0.002510, 0.007823, 0.011686, 0.023336, 0.039537
#*# 	  -0.136173, -0.132400, -0.118744, -0.110359, -0.103139, -0.098263, -0.094640, -0.094822, -0.100033, -0.091333, -0.079353, -0.071362, -0.065263, -0.057230, -0.048608, -0.043867, -0.043035, -0.032315, -0.023903, -0.012130, -0.003301, 0.004473, 0.012748, 0.028990, 0.045897
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = direct
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 150.0
#*# min_y = 25.0
#*# max_y = 150.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 26.130
#*# pid_ki = 1.592
#*# pid_kd = 107.186
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 35.490
#*# pid_ki = 1.621
#*# pid_kd = 194.305
#*#
#*# [beacon model default]
#*# model_coef = 1.6919408159524054,
#*# 	2.0330552097917263,
#*# 	0.7116550048269609,
#*# 	0.1712097062308795,
#*# 	0.3205513106033718,
#*# 	0.640631353592654,
#*# 	-0.3174505807953877,
#*# 	-0.8486978244100314,
#*# 	0.19389421973549364,
#*# 	0.40582503577675244
#*# model_domain = 1.8576801118660198e-07,1.9265152934395124e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 62.962388
#*# model_offset = -1.39000
