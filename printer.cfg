## Uncomment for input shaping via USB
#[include hyperion_config/crampon.cfg]

## Include other config files

[include shell_command.cfg]
[include macros/*.cfg]
[include reshelper.cfg]

#####################################################################
#  Misc
#####################################################################

[input_shaper]
shaper_freq_x: 85.6
shaper_type_x: mzv
damping_ratio_x: 0.0733

shaper_freq_y: 93
shaper_type_y: mzv
damping_ratio_y: 0.0366

[printer]
kinematics: cartesian
max_velocity: 1200  
max_accel: 25000
max_accel_to_decel: 25000
max_z_velocity: 75          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 2000
square_corner_velocity: 50.0

[virtual_sdcard]
path: ~/printer_data/gcodes

[display_status]

[respond]

[pause_resume]

[save_variables]
filename: ~/printer_data/config/saved_variables.cfg

[exclude_object]

# Enable arcs support
[gcode_arcs]
resolution: 0.1

#####################################################################
#  Controllers
#####################################################################
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_1F0034001551303531313638-if00

restart_method: command

#[mcu rpi]
#serial: /tmp/klipper_host_mcu


#####################################################################
#   Probe
#####################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_CF3C157F4E4B333448202020FF0A2532-if00
x_offset: -4 # update with offset from nozzle on your machine
y_offset: -30 # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2

# Mesh Bed Settings
[bed_mesh]
speed: 425
horizontal_move_z: 1
mesh_min: 25,20
mesh_max: 150,150
probe_count: 25,25
fade_start: 1.0
fade_end: 10.0
move_check_distance: 3
split_delta_z: 0.01
mesh_pps: 0,0
algorithm: bicubic
bicubic_tension: 0.2

#####################################################################
#   Fan Control
#####################################################################

[fan]
pin: PA1
tachometer_pin: PC3
off_below: 0.1
tachometer_poll_interval: 0.0005
hardware_pwm: true
#tachometer_ppr: 4

#cycle_time: 0.2
#kick_start_time: 0.5

[heater_fan hotend_fan]
pin: PA6
#max_power: 1.0
#cycle_time: 0.2
#kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[controller_fan casefan1]
pin: PA4
kick_start_time: 0.5
heater: heater_bed
fan_speed: 0.5


[controller_fan casefan2]
pin: PA3
kick_start_time: 0.5
heater: heater_bed
fan_speed: 0.5

[fan_generic rebreather]
pin: PF8
tachometer_pin: PC1

#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
##  SSR Pin - HE1
##  Thermistor - THB
heater_pin: PA0
sensor_type: Generic 3950
sensor_pin: PB1
pullup_resistor: 4700
max_power: 0.6
min_temp: 0
max_temp: 120
smooth_time: 2.0
#control = pid
#pid_kp = 52.779
#pid_ki = 1.419
#pid_kd = 490.844

#####################################################################
#   Extruder
#####################################################################

##  Connected to Motor 8
##  Heater - HE0
##  Thermistor - T0
##LDO 20mm Pancake 1.8 36STH20-1004AHG(XH) = 2.1Ohm 1.6mH
[extruder]
step_pin: PA10
dir_pin: PA9
enable_pin: !PA15
rotation_distance: 22.67895 #for 5mm Shaft Driven Bondtech gearsets
#gear_ratio: 50:10 #for standard 10t motor
gear_ratio: 50:8 #for sherpa mini 8t motor
microsteps: 16
full_steps_per_rotation: 200 #1.8deg Motor
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PF6
sensor_type: PT1000
sensor_pin: PB0
pullup_resistor: 2200
min_temp: 0
max_temp: 320
max_power: 1.0
min_extrude_temp: 0
max_extrude_only_distance: 200
max_extrude_cross_section: 5
pressure_advance: 0.03
pressure_advance_smooth_time: 0.02
#control = pid
#pid_kp = 24.103
#pid_ki = 2.329
#pid_kd = 62.368

#####################################################################
#   X/Y/Z Stepper Settings
#####################################################################

[stepper_x]
# connected to Motor 1
step_pin: PC13
dir_pin: !PC14
enable_pin: !PE6
# 0.9deg - 160 steps per mm - 1/16 microstepping
rotation_distance: 40
microsteps: 256
full_steps_per_rotation: 400
endstop_pin: tmc5160_stepper_x:virtual_endstop
#endstop_pin: PB14  # min
#endstop_pin: PA1   # max
position_min: -9
position_endstop: 180
position_max: 180
homing_speed: 80
homing_retract_dist: 0

[stepper_x1]
# connected to Motor 2
step_pin: PE4
dir_pin: PE5
enable_pin: !PE3
# 0.9deg - 160 steps per mm - 1/16 microstepping
rotation_distance: 40
microsteps: 256
full_steps_per_rotation: 400
endstop_pin: tmc5160_stepper_x1:virtual_endstop


[stepper_y]
# connected to Motor 3
step_pin: PE1
dir_pin: !PE0
enable_pin: !PE2
# 0.9deg - 160 steps per mm - 1/16 microstepping
rotation_distance: 40
microsteps: 256
full_steps_per_rotation: 400
endstop_pin: tmc5160_stepper_y:virtual_endstop
#endstop_pin: PB13  # min
#endstop_pin: PA2   # max
position_min: 0
position_endstop: 0
position_max: 184.5
homing_speed: 80
homing_retract_dist: 0

[stepper_y1]
# connected to Motor 4
step_pin: PB8
dir_pin: PB9
enable_pin: !PB7
# 0.9deg - 160 steps per mm - 1/16 microstepping
rotation_distance: 40
microsteps: 256
full_steps_per_rotation: 400
endstop_pin: tmc5160_stepper_y1:virtual_endstop



[stepper_z]
# connected to Motor 5
step_pin: PB5
dir_pin: PB4
enable_pin: !PB6
# 0.9deg - 2mm pitch 2mm lead - 1/8 microstepping
full_steps_per_rotation: 200
rotation_distance: 40
microsteps: 64
gear_ratio: 80:20

endstop_pin: probe:z_virtual_endstop
position_max: 170
position_min: -1
homing_speed: 25
homing_retract_dist: 0

[stepper_z1]
# connected to MOTOR 6
step_pin: PG15
dir_pin: !PB3
enable_pin: !PD5
# 0.9deg - 2mm pitch 2mm lead - 1/8 microstepping
full_steps_per_rotation: 200
microsteps: 64
rotation_distance: 40
gear_ratio: 80:20

[stepper_z2]
# connected to Motor 7
step_pin: PD3
dir_pin: !PD2
enable_pin: !PD4
# 0.9deg - 2mm pitch 2mm lead - 1/8 microstepping
full_steps_per_rotation: 200
microsteps: 64
rotation_distance: 40
gear_ratio: 80:20


# TMC Stepper Driver Settings
[tmc5160 stepper_x]
#uart_pin: PE8
#tx_pin: PE9    # comment out if using BTT 2209 drivers, and add a jumper between pins 4 and 5 of the driver
spi_bus: spi4
cs_pin: PG14
sense_resistor: 0.075
# Place a jumper on the two pin header near the endstop for sensorless homing
diag1_pin: ^!PF0  # connected to X- Endstop (X Jumper Header)
interpolate: false
run_current: 1.768
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3
driver_SGT: 1

[tmc5160 stepper_x1]
spi_bus: spi4
cs_pin: PG13
#uart_pin: PE0
#tx_pin: PE1    # comment out if using BTT 2209 drivers, and add a jumper between pins 4 and 5 of the driver
sense_resistor: 0.075
# Place a jumper on the two pin header near the endstop for sensorless homing
diag1_pin: ^!PF2   # connected to X+ Endstop (E2 Jumper Header)
interpolate: false
run_current: 1.768
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3
driver_SGT: 1

[tmc5160 stepper_y]
#uart_pin: PC4
#tx_pin: PE14   # comment out if using BTT 2209 drivers, and add a jumper between pins 4 and 5 of the driver
spi_bus: spi4
cs_pin: PG12
sense_resistor: 0.075
# Place a jumper on the two pin header near the endstop for sensorless homing
diag1_pin: ^!PF4
interpolate: false
run_current: 1.768
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3
driver_SGT: 1

[tmc5160 stepper_y1]
#uart_pin: PD12
#tx_pin: PC4    # comment out if using BTT 2209 drivers, and add a jumper between pins 4 and 5 of the driver
spi_bus: spi4
cs_pin: PG11
sense_resistor: 0.075
# Place a jumper on the two pin header near the endstop for sensorless homing
diag1_pin: ^!PF3
interpolate: false
run_current: 1.768
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3
driver_SGT: 1


[tmc2209 stepper_z]
uart_pin: PG10
interpolate: False
sense_resistor: 0.110
run_current: 1.1
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3

[tmc2209 stepper_z1]
uart_pin: PG9
interpolate: False
sense_resistor: 0.110
run_current: 1.1
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3

[tmc2209 stepper_z2]
uart_pin: PD7
interpolate: False
sense_resistor: 0.110
run_current: 1.1
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 3
driver_HEND: 3

[tmc2209 extruder]
uart_pin: PD6
interpolate: false
run_current: 0.4
sense_resistor: 0.110

#####################################################################
# 	Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

# Z Tilt Bed Adjustment Settings
[z_tilt]
# these positions assume the bed and rear rail are shifted 12mm to the right from what is in the edrawing
z_positions: 
    226.0, -18.0    # Front Right
    -74.0, -18.0    # Front Left
    76.0,  217.0    # Rear
points:
    170, 35         # Front Right
    20, 35          # Front Left
    94, 175        # Rear

Speed: 500
horizontal_move_z: 5.0
retries: 8
retry_tolerance: 0.005

#####################################################################
#   Additional Sensors
#####################################################################

[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PC5
min_temp: 0
max_temp: 100
gcode_id: chamber_th

[temperature_sensor Octopus]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 0
max_temp: 110

[gcode_macro _USE_INFILL_SQV]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set sqv = svv.infill_sqv | default(printer.configfile.settings.printer.square_corner_velocity, true) %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={ sqv }

[gcode_macro _USE_NORMAL_SQV]
gcode:
    {% set sqv = printer.configfile.settings.printer.square_corner_velocity %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={ sqv }

[gcode_macro SET_INFILL_SQV]
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set val = params.SQV|default(svv.infill_sqv|default(printer.configfile.settings.printer.square_corner_velocity, true), true) | int %}
    SAVE_VARIABLE VARIABLE=infill_sqv VALUE={val}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.5827376426546989,
#*# 	  1.897629881026976,
#*# 	  0.7137525467826924,
#*# 	  0.24914120761038594,
#*# 	  0.27833356219193395,
#*# 	  0.5068810352414286,
#*# 	  -0.11649322979895761,
#*# 	  -0.5371836163378004,
#*# 	  0.14152850544879494,
#*# 	  0.284625327921819
#*# model_domain = 3.112303526518321e-07,3.3138486054757704e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 67.300672
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.006739, -0.011882, -0.012497, -0.012078, -0.009866, -0.008612, -0.007973, -0.009466, -0.009529, -0.009981, -0.009181, -0.006521, -0.002339, -0.000536, -0.001731, -0.004116, -0.004772, -0.002193, 0.002128, 0.008591, 0.015781, 0.019902, 0.022616, 0.024767, 0.027586
#*# 	-0.006312, -0.008027, -0.009960, -0.007036, -0.002952, -0.000657, 0.000922, -0.001859, -0.001429, -0.000779, 0.000468, 0.002801, 0.006433, 0.009138, 0.007448, 0.006271, 0.005311, 0.008135, 0.011056, 0.018935, 0.025125, 0.029668, 0.035684, 0.037609, 0.041105
#*# 	0.003988, 0.000011, 0.000953, 0.001604, 0.004639, 0.008336, 0.009675, 0.008416, 0.007949, 0.009726, 0.010494, 0.013354, 0.018471, 0.020040, 0.019902, 0.018258, 0.017676, 0.019894, 0.023932, 0.029155, 0.037754, 0.042571, 0.046203, 0.048470, 0.051399
#*# 	0.015897, 0.014175, 0.011667, 0.014195, 0.018397, 0.020854, 0.023452, 0.022598, 0.022963, 0.026145, 0.027853, 0.030548, 0.035442, 0.039284, 0.038947, 0.037874, 0.036394, 0.039635, 0.043758, 0.050631, 0.057876, 0.062379, 0.066913, 0.064580, 0.068976
#*# 	0.024588, 0.021805, 0.019124, 0.020689, 0.024804, 0.027075, 0.028194, 0.028800, 0.029463, 0.031602, 0.033702, 0.037458, 0.043461, 0.047290, 0.046794, 0.045905, 0.045528, 0.049013, 0.052700, 0.058713, 0.066734, 0.068997, 0.072426, 0.073098, 0.075146
#*# 	0.036749, 0.031525, 0.025422, 0.025681, 0.029129, 0.032549, 0.034714, 0.034244, 0.037834, 0.040870, 0.041912, 0.047053, 0.051927, 0.056599, 0.056288, 0.054390, 0.054544, 0.058420, 0.060971, 0.067555, 0.073379, 0.079312, 0.083870, 0.083038, 0.085158
#*# 	0.054519, 0.045620, 0.039527, 0.037520, 0.039016, 0.038714, 0.040753, 0.042515, 0.045543, 0.049802, 0.053220, 0.056503, 0.064009, 0.068009, 0.069103, 0.067077, 0.066669, 0.070128, 0.075564, 0.078289, 0.085329, 0.089174, 0.094054, 0.100948, 0.100679
#*# 	0.073790, 0.063580, 0.053068, 0.049409, 0.051421, 0.053574, 0.056158, 0.057943, 0.060533, 0.061993, 0.066817, 0.072617, 0.078330, 0.083460, 0.083514, 0.082668, 0.083430, 0.086535, 0.090171, 0.096662, 0.104019, 0.107314, 0.111918, 0.113528, 0.119303
#*# 	0.074647, 0.062482, 0.054865, 0.050516, 0.053120, 0.054666, 0.056105, 0.057037, 0.060656, 0.062735, 0.067003, 0.068944, 0.074683, 0.080394, 0.081654, 0.080862, 0.079485, 0.082968, 0.088754, 0.095652, 0.104758, 0.112112, 0.116162, 0.121628, 0.126444
#*# 	0.070670, 0.059865, 0.051287, 0.047432, 0.049877, 0.052044, 0.054016, 0.055878, 0.059869, 0.061189, 0.064106, 0.069226, 0.077661, 0.082300, 0.085100, 0.085348, 0.086013, 0.089455, 0.094064, 0.100115, 0.107152, 0.116781, 0.123715, 0.128911, 0.138494
#*# 	0.068391, 0.058120, 0.050017, 0.047041, 0.050246, 0.050602, 0.051546, 0.051209, 0.054225, 0.058260, 0.060421, 0.067137, 0.076259, 0.081756, 0.087947, 0.087908, 0.088270, 0.093138, 0.097447, 0.102423, 0.112389, 0.116914, 0.121477, 0.133505, 0.141059
#*# 	0.057686, 0.054840, 0.050592, 0.049906, 0.050846, 0.052761, 0.055480, 0.056726, 0.058873, 0.060586, 0.063351, 0.069689, 0.078920, 0.086904, 0.090895, 0.091786, 0.094498, 0.098839, 0.103122, 0.110406, 0.118626, 0.125708, 0.134828, 0.143301, 0.155162
#*# 	0.056783, 0.051679, 0.047435, 0.046583, 0.049513, 0.048801, 0.044753, 0.044719, 0.046173, 0.051537, 0.053973, 0.058920, 0.068323, 0.074212, 0.084139, 0.086803, 0.088655, 0.092897, 0.098780, 0.105349, 0.112772, 0.119503, 0.128140, 0.139552, 0.150187
#*# 	0.043579, 0.044653, 0.046763, 0.047372, 0.048314, 0.048182, 0.046850, 0.045163, 0.047596, 0.049588, 0.054575, 0.062624, 0.070624, 0.079299, 0.085300, 0.088092, 0.092268, 0.097096, 0.102125, 0.112180, 0.119060, 0.123873, 0.132693, 0.139942, 0.154117
#*# 	0.042043, 0.047625, 0.050901, 0.049631, 0.047562, 0.045307, 0.042660, 0.041362, 0.046070, 0.051388, 0.055159, 0.060124, 0.069545, 0.073737, 0.081684, 0.087280, 0.084111, 0.090660, 0.097387, 0.105071, 0.112855, 0.118590, 0.124630, 0.136054, 0.148039
#*# 	0.024949, 0.034701, 0.037499, 0.041310, 0.041531, 0.039165, 0.036660, 0.035474, 0.037407, 0.041360, 0.044853, 0.050761, 0.060165, 0.066986, 0.074781, 0.080543, 0.087071, 0.093973, 0.100348, 0.109334, 0.116151, 0.122032, 0.129461, 0.136708, 0.149863
#*# 	0.013226, 0.019414, 0.027450, 0.032097, 0.030978, 0.025014, 0.023547, 0.021236, 0.027074, 0.030749, 0.035285, 0.040908, 0.048854, 0.056445, 0.063157, 0.068782, 0.073714, 0.082963, 0.095485, 0.104133, 0.108343, 0.115122, 0.123642, 0.134982, 0.140976
#*# 	-0.006100, 0.003572, 0.012482, 0.014832, 0.017308, 0.015192, 0.015689, 0.016793, 0.020068, 0.025679, 0.028205, 0.032391, 0.040563, 0.047869, 0.053781, 0.059603, 0.067398, 0.074972, 0.082731, 0.092286, 0.101417, 0.107216, 0.115377, 0.124179, 0.137680
#*# 	-0.015756, -0.008790, -0.003595, 0.002452, 0.009385, 0.009627, 0.007592, 0.009394, 0.016817, 0.022075, 0.019978, 0.023938, 0.029211, 0.035815, 0.042619, 0.047922, 0.055092, 0.061510, 0.076302, 0.085401, 0.093868, 0.102104, 0.111272, 0.120259, 0.130284
#*# 	-0.042166, -0.035906, -0.030113, -0.021804, -0.012957, -0.013820, -0.011575, -0.007835, -0.000909, 0.003732, 0.006800, 0.011832, 0.018773, 0.025726, 0.030707, 0.035906, 0.043991, 0.053237, 0.061267, 0.073587, 0.084549, 0.090757, 0.100176, 0.109686, 0.123604
#*# 	-0.054856, -0.046920, -0.040917, -0.035785, -0.030331, -0.023905, -0.021150, -0.019983, -0.012649, -0.005969, -0.002446, 0.001131, 0.012675, 0.019344, 0.026582, 0.031792, 0.039299, 0.047801, 0.058389, 0.067390, 0.072586, 0.082376, 0.090330, 0.101769, 0.116820
#*# 	-0.068406, -0.064203, -0.055305, -0.047328, -0.038403, -0.032888, -0.031293, -0.028288, -0.021228, -0.017779, -0.012555, -0.005029, 0.001850, 0.010045, 0.016287, 0.021804, 0.029345, 0.042285, 0.051635, 0.063330, 0.075550, 0.083864, 0.097136, 0.101773, 0.117044
#*# 	-0.082023, -0.074363, -0.066222, -0.059247, -0.052412, -0.049257, -0.046290, -0.040135, -0.035778, -0.030808, -0.024756, -0.015428, -0.007112, 0.000312, 0.007055, 0.012764, 0.022706, 0.033384, 0.044474, 0.057922, 0.068049, 0.078897, 0.091508, 0.100747, 0.110277
#*# 	-0.106477, -0.096313, -0.085547, -0.076123, -0.068712, -0.064008, -0.059199, -0.056599, -0.052174, -0.044356, -0.039378, -0.033091, -0.023427, -0.013666, -0.008180, -0.001306, 0.009183, 0.020856, 0.029839, 0.044160, 0.057515, 0.067902, 0.076709, 0.085882, 0.100600
#*# 	-0.122758, -0.115467, -0.103845, -0.096530, -0.088367, -0.078980, -0.075073, -0.071331, -0.063935, -0.056947, -0.051445, -0.044462, -0.033415, -0.030057, -0.024793, -0.017524, -0.006142, 0.005598, 0.016541, 0.031704, 0.044337, 0.059107, 0.063659, 0.079784, 0.091331
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = direct
#*# tension = 0.2
#*# min_x = 25.0
#*# max_x = 150.0
#*# min_y = 20.0
#*# max_y = 150.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.126
#*# pid_ki = 1.330
#*# pid_kd = 138.343
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 35.490
#*# pid_ki = 1.621
#*# pid_kd = 194.305
